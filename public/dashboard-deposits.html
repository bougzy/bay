<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deposits & Withdrawals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #fff; }
    .navbar { background-color: #1a1a1a; }
    .card { background-color: #1e1e1e; }
    .form-control { background-color: #2a2a2a; color: #fff; border: 1px solid #444; }
    .form-control:focus { background-color: #333; color: #fff; box-shadow: 0 0 5px #00d4ff; }
    .btn-primary { background-color: #00d4ff; border: none; }
    .btn-primary:hover { background-color: #00aacc; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark px-3">
  <a href="dashboard-deposits.html" class="navbar-brand">Deposits</a>
  <a href="dashboard-plans.html" class="nav-link">Plans</a>
  <a href="dashboard-referrals.html" class="nav-link">Referrals</a>
  <a href="dashboard-trading.html" class="nav-link">Copy-Trading</a>
  <a href="dashboard-messages.html" class="nav-link">Messages</a>
</nav>

<div class="container py-4">
  <h2 class="mb-3">Wallet Balance: $<span id="walletBalance">0.00</span></h2>
  <h4 class="mb-4">Profit Balance: $<span id="profitBalance">0.00</span></h4>

  <!-- Deposit Form -->
  <div class="card mb-4">
    <div class="card-header">New Deposit</div>
    <div class="card-body">
      <form id="depositForm">
        <input type="number" id="depositAmount" class="form-control mb-2" placeholder="Amount" required>
        <input type="file" id="depositProof" class="form-control mb-2" required>
        <button class="btn btn-primary w-100" type="submit">Submit Deposit</button>
      </form>
    </div>
  </div>

  <!-- Withdrawal Form -->
  <div class="card mb-4">
    <div class="card-header">Request Withdrawal</div>
    <div class="card-body">
      <form id="withdrawForm">
        <input type="number" id="withdrawAmount" class="form-control mb-2" placeholder="Amount" required>
        <button class="btn btn-outline-primary w-100" type="submit">Request Withdrawal</button>
      </form>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="card">
    <div class="card-header">Transactions</div>
    <div class="card-body">
      <table class="table table-dark table-striped">
        <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
        <tbody id="transactions"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
    
    // Save current dashboard page as last visited
localStorage.setItem("lastPage", window.location.pathname.split("/").pop());

// --- Helper: Fetch with Authorization ---
async function authFetch(url, options = {}) {
  const token = localStorage.getItem('token');
  options.headers = {
    ...options.headers,
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  };
  const res = await fetch(url, options);
  return res.json();
}

// --- Load User Info & Wallet ---
async function loadUser() {
  try {
    const user = await authFetch('/api/me');
    document.getElementById('walletBalance').innerText = parseFloat(user.walletBalance || 0).toFixed(2);
    document.getElementById('profitBalance').innerText = parseFloat(user.profitBalance || 0).toFixed(2);
  } catch (err) {
    console.error(err);
    alert('Failed to load user data');
  }
}

// --- Load Transactions ---
async function loadTransactions() {
  try {
    const txs = await authFetch('/api/user/transactions');
    const tbody = document.getElementById('transactions');
    tbody.innerHTML = '';
    txs.forEach(tx => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.createdAt).toLocaleString()}</td>
                      <td>${tx.type}</td>
                      <td>$${tx.amount}</td>
                      <td>${tx.status || 'Pending'}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
  }
}

// --- Handle Deposit ---
document.getElementById('depositForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const amount = parseFloat(document.getElementById('depositAmount').value);
  const proofFile = document.getElementById('depositProof').files[0];

  if (!amount || amount <= 0 || !proofFile) {
    alert('Enter valid amount and upload proof');
    return;
  }

  const formData = new FormData();
  formData.append('amount', amount);
  formData.append('proof', proofFile);

  try {
    const token = localStorage.getItem('token');
    const res = await fetch('/api/deposits', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });
    const data = await res.json();
    if (!res.ok) { alert(data.message); return; }
    alert('Deposit request submitted!');
    loadUser();
    loadTransactions();
    document.getElementById('depositForm').reset();
  } catch (err) {
    console.error(err);
    alert('Deposit failed');
  }
});

// --- Handle Withdrawal ---
document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const amount = parseFloat(document.getElementById('withdrawAmount').value);

  if (!amount || amount <= 0) { alert('Enter valid amount'); return; }

  try {
    const data = await authFetch('/api/withdrawals', { method: 'POST', body: JSON.stringify({ amount }) });
    if (data.message) alert(data.message);
    loadUser();
    loadTransactions();
    document.getElementById('withdrawForm').reset();
  } catch (err) {
    console.error(err);
    alert('Withdrawal request failed');
  }
});

// --- Initialize ---
loadUser();
loadTransactions();
</script>

</body>
</html>
